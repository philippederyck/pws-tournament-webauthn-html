<!DOCTYPE html>
<html>
  <head>
    <title>Passkeys</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="text-center">Passkey demo application</h1>

      <div class="row">
        <div class="col text-center">
          <p id="msg" class="alert alert-warning d-none mt-5">
            This application does not work when running in a Stackblitz frame.
            To use the Web Authentication API, make sure you
            <a id="link" target="_blank"
              >open the application in a top-level window</a
            >.
            <br />
            <br />
            Make sure that if the application runtime environment reinitializes,
            you also reload the application.
          </p>
        </div>
      </div>
      <div class="row">
        <div
          class="
            col-8
            offset-2
            col-md-6
            offset-md-3
            col-lg-4
            offset-lg-4
            text-center
          "
        >
          <button
            id="btn"
            class="btn btn-primary mt-5"
            onclick="registerPasskey()"
          >
            Create Passkey
          </button>

          <p id="show_link" class="mt-5 d-none">
            Passkey has been created.
            <a href="login.html"> Click here to go to the login page</a>.
          </p>
        </div>
      </div>
    </div>

    <script>
      async function registerPasskey() {
        // This data is coming from the server after we submitted an email address
        const serverData = {
          rpId: document.location.host,
          userId: '33c63b9c1dde4e2eb79192a283c37fe3',
          email: 'philippe@pragmaticwebsecurity.com',
        };

        try {
          // Configure the WebAuthN options
          const createCredentialOptions = {
            publicKey: {
              rp: {
                id: serverData.rpId,
                name: 'WebAuthN demo application',
              },
              user: {
                id: Uint8Array.from(serverData.userId, (c) => c.charCodeAt(0)),
                name: serverData.email,
                displayName: serverData.email,
              },
              pubKeyCredParams: [
                {
                  type: 'public-key',
                  alg: -7,
                },
                {
                  type: 'public-key',
                  alg: -257,
                },
              ],

              // Not needed during registration
              challenge: new Uint8Array([0]),

              authenticatorSelection: {
                userVerification: 'required',
                authenticatorAttachment: 'cross-platform',
                requireResidentKey: true,
              },
            },
          };

          // Create the passkey
          console.log(
            'Creating passkey with the data provided by the server ...'
          );
          const credential = await navigator.credentials.create(
            createCredentialOptions
          );
          console.log('Passkey has been created...');

          await submitCredentialDataToServer(credential);
        } catch (error) {
          alert(
            `Failed to register a passkey: ${error.message} (more details in the console)`
          );
          console.log(error);
        }
      }

      async function submitCredentialDataToServer(credential) {
        // Omitted the step of sending the credential response data to the server
        // Data structure: https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential/response

        document.getElementById('show_link').classList.remove('d-none');
      }

      function detectFrame() {
        document.getElementById('link').href = document.location;
        if (top != self) {
          document.getElementById('msg').classList.remove('d-none');
          document.getElementById('btn').classList.add('d-none');
        }
      }
      document.addEventListener('DOMContentLoaded', detectFrame);
    </script>
  </body>
</html>
