<!DOCTYPE html>
<html>
  <head>
    <title>WebAuthN</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="text-center">WebAuthN demo application</h1>

      <div class="row">
        <div class="col text-center">
            <button onclick="registerPubkey()">Create WebAuthN Credential</button>
        </div>
      </div>
    </div>

    <script>
        async function registerPubkey() {
            // This data is coming from the server, a step we skip in this demo
            const serverData = {
                rpId: "pragmaticwebsecurity.com",
                userId: "33c63b9c1dde4e2eb79192a283c37fe3",
                userName: "philippe",
                userDisplayName: "Philippe De Ryck"
            }

            try {
                // Configure the WebAuthN options
                const createCredentialOptions = {
                    publicKey: {
                        rp: {
                            id: serverData.rpId,
                            name: "WebAuthN demo application",
                        },
                        user: {
                            id: Uint8Array.from(serverData.userId, c => c.charCodeAt(0)),
                            name: serverData.userName,
                            displayName: serverData.userDisplayName
                        },
                        pubKeyCredParams: [{
                            type: "public-key",
                            alg: -7
                        }, {
                            type: "public-key",
                            alg: -257
                        }],

                        // Not needed during registration
                        challenge: new Uint8Array([0]),

                        authenticatorSelection: {
                            userVerification: 'discouraged'
                        },
                    }
                };

                // Create the credential
                console.log("Creating credential with the data provided by the server ...")
                const credential = await navigator.credentials.create(createCredentialOptions)
                console.log("Credential has been created...")
                
                await submitCredentialDataToServer(credential)
            }
            catch(error) {
                alert(`Failed to register a public key: ${error.message} (more details in the console)`)
                console.log(error)
            }
        }

        async function submitCredentialDataToServer(credential) {
            // Omitted the step of sending the credential response data to the server
            // Data structure: https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential/response
        }
    </script>
  </body>
</html>